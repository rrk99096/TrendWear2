{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register | TrendWear</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
    
    <style>
        /* Basic Layout */
        body { background-color: #f9f9f9; padding-top: 100px; font-family: 'Poppins', sans-serif; display: flex; justify-content: center; min-height: 100vh; }
        .navbar-fixed { position: fixed; top: 0; left: 0; width: 100%; background: #fff; display: flex; justify-content: space-between; padding: 20px 40px; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .navbar-fixed a { color: #1a1a1a; text-decoration: none; font-weight: 600; }
        
        /* Register Box */
        .register-container { background: white; padding: 40px; width: 100%; max-width: 450px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: center; margin-bottom: 50px; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-size: 0.9rem; margin-bottom: 5px; color: #333; font-weight: bold; }
        
        /* Input Styling */
        .form-input, input[type="text"], input[type="email"], input[type="password"] {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 1rem;
        }
        
        /* === ERROR MESSAGE STYLING === */
        .error-text {
            color: #d8000c;
            font-size: 0.85rem;
            margin-top: 5px;
            display: block;
            font-weight: 500;
        }
        .input-error {
            border-color: #d8000c !important; /* Make border red if error */
            background-color: #fff8f8;
        }

        /* Buttons */
        .verify-row { display: flex; gap: 10px; }
        .btn-verify { background: #d4af37; color: white; border: none; padding: 0 15px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; white-space: nowrap; }
        .btn-submit { width: 100%; background: #1a1a1a; color: white; padding: 15px; border: none; font-weight: bold; margin-top: 20px; cursor: pointer; border-radius: 5px; }
    </style>
</head>
<body>

    <nav class="navbar-fixed">
        <div class="logo">TREND<span>WEAR</span></div>
        <div class="nav-icons"><a href="{% url 'login' %}">LOGIN</a></div>
    </nav>

    <div class="register-container">
        <h2>Create Account</h2>

        {% if messages %}
            {% for message in messages %}
            <div style="background:#ffe6e6; color:red; padding:10px; margin-bottom:15px; border-radius:4px;">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}

        <form method="POST">
            {% csrf_token %}
            
            <div class="form-group">
                <label>First Name</label>
                {{ form.first_name }}
                {% for error in form.first_name.errors %}
                    <small class="error-text">{{ error }}</small>
                {% endfor %}
            </div>

            <div class="form-group">
                <label>Last Name</label>
                {{ form.last_name }}
                {% for error in form.last_name.errors %}
                    <small class="error-text">{{ error }}</small>
                {% endfor %}
            </div>

            <div class="form-group">
                <label>Mobile Number</label>
                {{ form.phone_number }}
                {% for error in form.phone_number.errors %}
                    <small class="error-text">{{ error }}</small>
                {% endfor %}
            </div>

            <div class="form-group">
                <label>Email Address</label>
                <div class="verify-row">
                    {{ form.email }}
                    <button type="button" class="btn-verify" id="otpBtn" onclick="sendOTP()">Get Code</button>
                </div>
                {% for error in form.email.errors %}
                    <small class="error-text">{{ error }}</small>
                {% endfor %}
                <small id="otpMessage" style="display: none; margin-top: 5px;"></small>
            </div>

            <div class="form-group" id="otpField" style="display: none;">
                <label>Verification Code</label>
                <input type="text" name="otp_code" class="form-input" placeholder="Enter OTP">
            </div>

            <div class="form-group">
                <label>Password</label>
                {{ form.password }}
                {% for error in form.password.errors %}
                    <small class="error-text">{{ error }}</small>
                {% endfor %}
            </div>

            <div class="form-group">
                <label>Confirm Password</label>
                {{ form.confirm_password }}
                {% for error in form.confirm_password.errors %}
                    <small class="error-text">{{ error }}</small>
                {% endfor %}
            </div>

            <button type="submit" class="btn-submit">Sign Up</button>
        </form>

        <p style="margin-top:20px;">Already have an account? <a href="{% url 'login' %}">Login</a></p>
    </div>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function sendOTP() {
            const email = document.querySelector('input[name="email"]').value;
            const btn = document.getElementById('otpBtn');
            const msg = document.getElementById('otpMessage');
            const otpField = document.getElementById('otpField');
            const csrftoken = getCookie('csrftoken');

            if(!email) { alert("Enter email first"); return; }
            btn.innerText = "Sending..."; btn.disabled = true;

            fetch("{% url 'send_otp' %}", {
                method: "POST", headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
                body: JSON.stringify({ email: email })
            })
            .then(r => r.json())
            .then(d => {
                msg.style.display = 'block';
                if(d.status === 'success') {
                    msg.innerText = "Code sent!"; msg.style.color = 'green';
                    otpField.style.display = 'block'; btn.innerText = "Sent";
                } else {
                    msg.innerText = d.message; msg.style.color = 'red'; btn.disabled = false; btn.innerText = "Try Again";
                }
            });
        }
    </script>
</body>
</html>